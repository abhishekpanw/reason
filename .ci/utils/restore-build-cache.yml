# Steps for restoring project cache

steps:
  - bash: 'mkdir -p $(STAGING_DIRECTORY_UNIX)'
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/master'))
    displayName: '[Cache][Publish] Create cache directory'

  - task: Bash@3
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/master'))
    displayName: '[Cache][Restore] Restoring build cache using REST API'
    continueOnError: true
    inputs:
      targetType: 'inline' # Optional. Options: filePath, inline
      script: |
        ORG="reasonml"
        REST_BUILDS="https://dev.azure.com/$ORG/$SYSTEM_TEAMPROJECT/"'_apis/build/builds?deletedFilter=excludeDeleted&statusFilter=completed&resultFilter=succeeded&queryOrder=finishTimeDescending&$top=1&api-version=4.1'
        REST_BUILDS_RESP=$(curl "$REST_BUILDS")

        if [[ $REST_BUILDS_RESP =~ (\"web\":\{\"href\":\")([^\"]*) ]]; then BUILD_PAGE="${BASH_REMATCH[2]}"; else BUILD_PAGE=""; fi
        if [[ $REST_BUILDS_RESP =~ (\"badge\":\{\"href\":\")([^\"]*) ]]; then BUILD_BADGE="${BASH_REMATCH[2]}"; else BUILD_BADGE=""; fi
        if [[ $REST_BUILDS_RESP =~ (\"id\":)([^,]*) ]]; then BUILD_ID="${BASH_REMATCH[2]}"; else BUILD_ID=""; fi



        ART_NAME="cache-${AGENT_OS}-install"
        REST_ART="https://dev.azure.com/$ORG/$SYSTEM_TEAMPROJECT/_apis/build/builds/$BUILD_ID/artifacts?artifactName=$ART_NAME&api-version=4.1"
        if [[ $(curl $REST_ART) =~ (downloadUrl\":\")([^\"]*) ]]; then ART_URL="${BASH_REMATCH[2]}"; else ART_URL=""; fi


        echo "Using Dependency cache for buildID: $BUILD_ID"
        echo "Build log for build that produced the cache: $BUILD_PAGE"
        echo "Build badge for build that produced the cache: $BUILD_BADGE"
        echo "Build artifact from build that produced the cache: $ART_URL"

        curl "$ART_URL" > "${STAGING_DIRECTORY_UNIX}/$ART_NAME.zip"
        cd $STAGING_DIRECTORY_UNIX
        unzip "$ART_NAME.zip"
        ls $STAGING_DIRECTORY_UNIX
        
      

  - bash: 'mkdir -p $(ESY__CACHE_INSTALL_PATH)'
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/master'))
    displayName: '[Cache][Restore] Create esy cache directory'

  # - bash: 'cd $(ESY__NPM_ROOT) && tar -xf $(STAGING_DIRECTORY_UNIX)/cache-$(Agent.OS)-install/npm-cache.tar -C .'
  #   continueOnError: true
  #   condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/master'))
  #   displayName: '[Cache][Restore] Untar npm cache directory'

  - bash: 'cd $(ESY__CACHE_INSTALL_PATH) && tar -xf $(STAGING_DIRECTORY_UNIX)/cache-$(Agent.OS)-install/esy-cache.tar -C .'
    continueOnError: true
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/master'))
    displayName: '[Cache][Restore] Untar esy cache directory'

  - bash: 'rm -rf *'
    continueOnError: true
    workingDirectory: '$(STAGING_DIRECTORY)'
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/master'))
    displayName: '[Cache][Restore] Clean up'
